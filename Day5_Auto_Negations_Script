function main() {
  var EMAIL = 'nikhargeraj@gmail.com';
  var SUBJECT = 'Auto-Negated Irrelevant (Non-Online/Hybrid/Course) Search Terms Report';

  // Keywords that INDICATE the mode we WANT to KEEP (online / distance / hybrid / course / part-time / evening / weekend etc.) Add keywords according to your own logic for your account
  var wantedPatterns = [
    'online',
    'distance',
    'correspondence',
    'remote',
    'virtual',
    'hybrid',
    'blended',
    'part time',
    'part-time',
    'evening',
    'weekend',
    'week end',
    'night',
    'flexible',
    'flexi',
    'recorded',
    'pre recorded',
    'self paced',
    'self-paced',
    'online mba',
    'online mca',
    'online pgdm',
    'online course',
    'online degree',
    'distance mba',
    'distance mca',
    'correspondence mba',
    'online learning',
    'e learning',
    'e-learning',
    // Add more specific course/format keywords if needed, e.g.
    // 'pg diploma', 'certificate course', 'diploma course', 'crash course', etc.
  ];

  // Convert to lowercase for case-insensitive matching
  var wantedLower = wantedPatterns.map(function(s) { return s.toLowerCase(); });

  var negatedThisRun = [];

  // Consider changing to LAST_1_DAY or LAST_3_DAYS for faster reaction
  var report = AdsApp.report(
    "SELECT Query, CampaignName, AdGroupName, Clicks, Conversions, Cost, Impressions " +
    "FROM SEARCH_QUERY_PERFORMANCE_REPORT " +
    "DURING LAST_7_DAYS"   // ← change here if desired
  );

  var rows = report.rows();
  var toNegate = {};

  while (rows.hasNext()) {
    var row = rows.next();
    var query = row['Query'].toLowerCase().trim();

    if (query.length < 4) continue;

    var containsWantedTerm = false;

    for (var i = 0; i < wantedLower.length; i++) {
      if (query.indexOf(wantedLower[i]) !== -1) {
        containsWantedTerm = true;
        break;
      }
    }

    // NEGATE if the query does NOT contain any wanted pattern
    if (!containsWantedTerm) {
      var key = query;

      if (!toNegate[key]) {
        toNegate[key] = {
          query: row['Query'],
          clicks: parseInt(row['Clicks'] || 0),
          cost: parseFloat(row['Cost'] || 0),
          impressions: parseInt(row['Impressions'] || 0),
          conversions: parseFloat(row['Conversions'] || 0),
          campaigns: {},
          adgroups: {}
        };
      }

      var camp = row['CampaignName'];
      var ag = row['AdGroupName'];

      toNegate[key].campaigns[camp] = true;
      toNegate[key].adgroups[ag] = true;
    }
  }

  var alreadyNegated = {};
  var existingNegatives = AdsApp.negativeKeywords().get();
  while (existingNegatives.hasNext()) {
    var neg = existingNegatives.next();
    alreadyNegated[neg.getText().toLowerCase()] = true;
  }

  var newlyAddedCount = 0;

  for (var q in toNegate) {
    var item = toNegate[q];
    var cleanQuery = item.query.trim();
    var lowerQuery = cleanQuery.toLowerCase();

    if (alreadyNegated[lowerQuery]) continue;

    try {
      AdsApp.createNegativeKeyword(cleanQuery);  // broad match negative
      newlyAddedCount++;
      negatedThisRun.push({
        query: cleanQuery,
        clicks: item.clicks,
        cost: item.cost.toFixed(2),
        impressions: item.impressions,
        conversions: item.conversions,
        campaigns: Object.keys(item.campaigns).join(', '),
        adgroups: Object.keys(item.adgroups).join(', ')
      });
    } catch (e) {
      Logger.log('Could not negate: ' + cleanQuery + ' → ' + e);
    }
  }

  var html = '<html><head><style>' +
    'body{font-family:Arial,sans-serif;line-height:1.5;color:#333;}' +
    'table{border-collapse:collapse;width:100%;margin:20px 0;}' +
    'th,td{border:1px solid #ddd;padding:10px;text-align:left;}' +
    'th{background:#f5f7fa;font-weight:bold;}' +
    '.highlight{color:#d32f2f;font-weight:bold;}' +
    'h2{color:#1565c0;margin-top:30px;}' +
    '</style></head><body>';

  html += '<h1>Auto Negative Keywords Report (Non-Online Mode)</h1>';
  html += '<p><strong>Date:</strong> ' + new Date().toLocaleString('en-IN', {timeZone: 'Asia/Kolkata'}) + '</p>';
  html += '<p><strong>Account:</strong> ' + AdsApp.currentAccount().getName() + '</p>';
  html += '<p>Script automatically negated search terms that <strong>do NOT</strong> contain online, distance, hybrid, course, part-time, evening, weekend, etc. patterns.</p>';

  html += '<h2>Summary</h2>';
  html += '<ul>';
  html += '<li>New negative keywords added this run: <strong>' + newlyAddedCount + '</strong></li>';
  html += '<li>Keywords checked from last 7 days search queries</li>';
  html += '</ul>';

  if (negatedThisRun.length > 0) {
    html += '<h2>Keywords Negated This Run (irrelevant offline/generic terms)</h2>';
    html += '<table>';
    html += '<tr><th>Search Term</th><th>Clicks</th><th>Cost (₹)</th><th>Impr.</th><th>Conv.</th><th>Appeared In Campaigns</th></tr>';

    negatedThisRun.sort(function(a,b){ return b.clicks - a.clicks || b.cost - a.cost; });

    negatedThisRun.forEach(function(item) {
      html += '<tr>' +
        '<td class="highlight">' + item.query + '</td>' +
        '<td>' + item.clicks + '</td>' +
        '<td>₹' + item.cost + '</td>' +
        '<td>' + item.impressions.toLocaleString() + '</td>' +
        '<td>' + item.conversions.toFixed(1) + '</td>' +
        '<td>' + item.campaigns + '</td>' +
        '</tr>';
    });

    html += '</table>';

    html += '<p><strong>Total wasted spend blocked (approx):</strong> ₹' +
            negatedThisRun.reduce(function(sum, item){ return sum + parseFloat(item.cost); }, 0).toFixed(2) +
            ' from these terms in the last 7 days.</p>';
  } else {
    html += '<h2>No new terms negated this run</h2>';
    html += '<p>All detected generic/offline queries were already negated or no matching traffic found.</p>';
  }

  html += '<p style="margin-top:40px;font-size:13px;color:#555;">' +
          'This script adds account-level broad negative keywords.<br>' +
          'Review in Shared Library → Negative keyword lists.</p>';

  html += '</body></html>';

  MailApp.sendEmail({
    to: EMAIL,
    subject: SUBJECT,
    htmlBody: html
  });

  Logger.log('Negated ' + newlyAddedCount + ' new irrelevant terms this run.');
}
